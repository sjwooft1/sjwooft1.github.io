<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Brighton Oaks 5K — Live Results</title>
  <link rel="icon" type="image/png" href="/Favicon Generator/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/Favicon Generator/favicon.svg" />
  <link rel="shortcut icon" href="/Favicon Generator/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/Favicon Generator/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="BO 5k" />
  <link rel="manifest" href="/Favicon Generator/site.webmanifest" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    @font-face{
      font-family: 'Oakhill';
      src: url('fonts/Oakhill.ttf') format('truetype');
    }
    @font-face{
      font-family: 'run';
      src: url('fonts/RUNNING DEMO.otf') format('opentype');
    }
    :root {
      --accent: #3b6e22;
      --accent2: #ff7f11;
      --bg: #0f1724;
      --card: #131f33;
      --text: #e6eef8;
      --muted: #9ca3af;
      --shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%; margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text);
    }
    .navbar {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 28px; background: #101b2f; box-shadow: var(--shadow);
      position: sticky; top: 0; z-index: 100;
    }
    .navbar .logo { 
      font-size: 1.5rem; 
      font-weight: 700; 
      color: var(--accent2);
      font-family: 'Luckiest Guy', cursive;
    }
    .navbar .nav-links { 
      font-family: 'run', sans-serif;
      display: flex; 
      gap: 14px; 
    }
    .navbar a {
      text-decoration: none; color: var(--text); font-weight: 600;
      transition: 0.2s; padding: 6px 12px; border-radius: 8px;
    }
    .navbar a:hover, .navbar a.active { background: var(--accent2); color: #fff; }

    .hero {
      height: 40vh; display: flex; align-items: center; justify-content: center;
      background: url('images/road.jpeg') center/cover no-repeat;
      position: relative; color: white; text-align: center;
    }
    .hero::after {
      content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.5);
    }
    .hero h1 { z-index: 1; font-size: 2.5rem; text-shadow: 0 4px 14px rgba(0,0,0,0.6); }

    #map { height: 50vh; margin-top: 20px; border-radius: 16px; overflow: hidden; box-shadow: var(--shadow); }

    .dashboard {
      display: grid; grid-template-columns: 2fr 1fr; gap: 20px; padding: 20px; max-width: 1200px; margin: auto;
    }
    .card {
      background: var(--card); border-radius: 16px; padding: 20px; box-shadow: var(--shadow);
    }
    .card h2 { margin-top: 0; color: var(--accent2); }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
    th { color: var(--accent2); font-weight: 600; }
    tr.highlight { background: rgba(255,127,17,0.15); }

    .pace { color: var(--muted); font-size: 0.9rem; }
    .clock {
      font-size: 2rem; text-align: center; margin: 16px 0; font-weight: 600;
      color: var(--accent2); text-shadow: 0 0 20px rgba(255,127,17,0.3);
    }

    .footer {
      background: #101b2f; color: #aaa; text-align: center; padding: 30px 12px;
      margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.05);
    }

    @media (max-width: 900px) {
      .dashboard { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="logo">Brighton Oaks 5K</div>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="registration.html">Register</a>
      <a href="results.html" class="active">Results</a>
      <a href="bibprinter.html">Bib Printer</a>
    </div>
  </nav>

  <section class="hero">
    <h1>Live Race Spectator View</h1>
  </section>

  <div class="clock" id="raceClock">Race clock: 00:00.000</div>
  <div id="map"></div>

  <div class="dashboard">
    <div class="card">
      <h2>Live Leaderboard</h2>
      <div id="leaderboard">Loading results...</div>
    </div>
    <div class="card">
      <h2>Runner Details</h2>
      <div id="runnerResult">Select a runner to view details.</div>
    </div>
  </div>

  <footer class="footer">
    © 2025 Brighton Oaks 5K — All rights reserved.
  </footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDUnAV-DL-Saw2ByPY6GF8aDaZbVCXDIH4",
      authDomain: "the-race-organizer.firebaseapp.com",
      databaseURL: "https://the-race-organizer-default-rtdb.firebaseio.com",
      projectId: "the-race-organizer",
      storageBucket: "the-race-organizer.firebasestorage.app",
      messagingSenderId: "265977321479",
      appId: "1:265977321479:web:23d3f3077e8e766323b2a2",
      measurementId: "G-PKGPD78DYM"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // --- Map setup ---
    const map = L.map('map').setView([39.8283, -98.5795], 4);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);
    let poly = L.polyline([], {color: "#ff7f11", weight: 4}).addTo(map);

    // --- Helper Functions ---
    function formatMs(ms) {
      const m = Math.floor(ms/60000), s = Math.floor((ms%60000)/1000);
      return `${m}:${String(s).padStart(2,'0')}`;
    }

    function calcPacePerMile(ms, distanceMiles) {
      const paceMs = ms / distanceMiles;
      const min = Math.floor(paceMs / 60000);
      const sec = Math.floor((paceMs % 60000) / 1000);
      return `${min}:${String(sec).padStart(2,'0')} / mi`;
    }

    // --- Leaderboard Sync ---
    onValue(ref(db, "results"), snap => {
      const results = snap.val();
      if (!results) return;
      const arr = Object.values(results).filter(r => r.finishTime);
      arr.sort((a,b)=>a.finishTime-b.finishTime);
      const raceDistanceMiles = 3.10686;
      const params = new URLSearchParams(window.location.search);
      const rid = params.get("result");

      let html = `<table><thead><tr><th>#</th><th>Name</th><th>Time</th><th>Pace</th></tr></thead><tbody>`;
      arr.forEach((r, i) => {
        const pace = calcPacePerMile(r.finishTime, raceDistanceMiles);
        html += `<tr class="${rid===r.id?'highlight':''}"><td>${i+1}</td><td>${r.name}</td><td>${formatMs(r.finishTime)}</td><td class='pace'>${pace}</td></tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById("leaderboard").innerHTML = html;

      if (rid && results[rid]) {
        const rr = results[rid];
        const pace = calcPacePerMile(rr.finishTime, raceDistanceMiles);
        document.getElementById("runnerResult").innerHTML = `
          <h3>${rr.name}</h3>
          <p><b>Time:</b> ${formatMs(rr.finishTime)}</p>
          <p><b>Pace:</b> ${pace}</p>
          <p><b>Bib:</b> ${rr.bibNumber || rr.bib || '–'}</p>
        `;
      }
    });

    // --- Route ---
    onValue(ref(db, "route"), snap => {
      const data = snap.val();
      if (!data || !data.points) return;
      poly.setLatLngs(data.points);
      map.fitBounds(poly.getBounds());
    });

    // --- Race Clock ---
    let raceClock = { raceStart: null, running: false, paused: false, pausedAt: null };
    onValue(ref(db, "raceClock"), snap => { raceClock = snap.val() || raceClock; });

    function updateClock() {
      const el = document.getElementById('raceClock');
      if (!raceClock.raceStart) { el.textContent = 'Race clock: 00:00.000'; return; }
      let ms = 0;
      if (raceClock.paused && raceClock.pausedAt) ms = raceClock.pausedAt - raceClock.raceStart;
      else if (raceClock.running) ms = Date.now() - raceClock.raceStart;
      el.textContent = 'Race clock: ' + formatMs(ms);
    }
    setInterval(updateClock, 100);
  </script>
</body>
</html>

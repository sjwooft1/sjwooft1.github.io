<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Race Bib Maker</title>
  <style>
    body {
      font-family: "Arial Black", sans-serif;
      text-align: center;
      padding: 20px;
      background: #f4f4f4;
    }
    button, input[type="file"] {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      font-weight: bold;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    input[type="file"] {
      background: #28a745;
    }
    input[type="file"]:hover {
      background: #1e7e34;
    }
    .bib {
      width: 700px;
      height: 400px;
      border: 8px solid #000;
      border-radius: 20px;
      margin: 30px auto;
      background: white;
      position: relative;
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
      page-break-after: always;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px;
    }
    .logo {
     position: absolute;
     bottom: 20px;
     left: 20px;
     width: 120px;
    }

    .race-title {
      font-size: 40px;
      font-weight: bold;
      margin-top: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .bib-number {
      font-size: 160px;
      font-weight: bold;
      margin: 0 auto;
      text-align: center;
    }
    .runner-name {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .qrcode {
      position: absolute;
      bottom: 20px;
      right: 20px;
    }
    #bibs {
      margin-top: 20px;
    }
    /* Notification system */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }
    .notification.show {
      opacity: 1;
      transform: translateX(0);
    }
    .notification.error {
      background: #dc3545;
    }
    .notification.warning {
      background: #ffc107;
      color: #000;
    }
    
    /* Settings panel */
    .settings-panel {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border: 1px solid #dee2e6;
    }
    .settings-panel label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 5px 0;
      font-size: 14px;
    }
    .settings-panel input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    @media print {
      body {
        background: white;
        margin: 0;
        padding: 0;
      }
      button, input[type="file"], h1, p, .settings-panel, .notification {
        display: none !important;
      }
      .bib {
        box-shadow: none;
        margin: 10px auto;
        page-break-inside: avoid;
      }
      #bibs {
        margin: 0;
        padding: 0;
      }
    }
  </style>
</head>
<body>
  <h1>Race Bib Maker</h1>
  
  <div class="settings-panel">
    <h3 style="margin-top:0;">Settings</h3>
    <label>
      <input type="checkbox" id="skipConfirmations" checked>
      Skip confirmation dialogs (faster operation)
    </label>
    <label>
      <input type="checkbox" id="showNotifications" checked>
      Show success notifications
    </label>
  </div>
  
  <p>Upload a race logo (optional):</p>
  <input type="file" id="logoUpload" accept="image/*"><br>
  <button onclick="loadRunners()">Load Runners & Generate Bibs</button>
  <button onclick="printBibs()">Print Bibs</button>
  <button onclick="manualPrint()" style="background:#17a2b8; color:white;">Manual Print (Ctrl+P)</button>
  
  <div id="bibs"></div>
  
  <!-- Notification container -->
  <div id="notification" class="notification"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- QRCode library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // ✅ Replace with your Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyDUnAV-DL-Saw2ByPY6GF8aDaZbVCXDIH4",
    authDomain: "the-race-organizer.firebaseapp.com",
    databaseURL: "https://the-race-organizer-default-rtdb.firebaseio.com",
    projectId: "the-race-organizer",
    storageBucket: "the-race-organizer.firebasestorage.app",
    messagingSenderId: "265977321479",
    appId: "1:265977321479:web:23d3f3077e8e766323b2a2",
    measurementId: "G-PKGPD78DYM"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let uploadedLogo = null;

    // Handle logo upload
    document.getElementById("logoUpload").addEventListener("change", function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          uploadedLogo = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // ---------- REPLACE loadRunners() WITH THIS ----------
function loadRunners() {
  const bibsDiv = document.getElementById("bibs");
  bibsDiv.innerHTML = "";

  database.ref("registrations").once("value")
    .then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        showNotification("No runners found in Firebase.", 'warning');
        return;
      }

      // Build array of runners from the random-code children
      const runners = Object.keys(data).map(key => {
        const entry = data[key] || {};
        // robust name lookup with fallbacks
        const name = entry.name || entry.runnerName || entry.displayName || key;

        // robust estimated-time lookup & numeric conversion
        let raw = entry.estimatedtime ?? entry.estimatedTime ?? entry.estimated ?? null;
        let estimated;
        if (raw === null || raw === undefined || raw === "") {
          estimated = Infinity; // push missing times to the end
        } else {
          estimated = Number(raw);
          if (isNaN(estimated)) {
            // try to salvage digits if stored oddly
            const digits = String(raw).replace(/\D/g, "");
            const p = digits ? parseInt(digits, 10) : NaN;
            estimated = isNaN(p) ? Infinity : p;
          }
        }
        return { key, name, estimated, raw };
      });

      console.log("Loaded runners (before sort):", runners.map(r => ({ name: r.name, estimated: r.estimated })));

      // Sort by numeric milliseconds (ascending = fastest first).
      // Tie-breaker: name alphabetical (deterministic)
      runners.sort((a, b) => {
        if (a.estimated !== b.estimated) return a.estimated - b.estimated;
        return ("" + a.name).localeCompare(b.name);
      });

      console.log("Runners (after sort):", runners.map((r, i) => ({ rank: i + 1, name: r.name, estimated: r.estimated })));

      // Create bibs in sorted order
      runners.forEach((runner, index) => {
        const bibNum = String(index + 1).padStart(4, "0"); // 0001, 0002, ...
        createBib(runner.name, bibNum, runner.estimated);
      });
      
      showNotification(`Loaded ${runners.length} runners and generated bibs`);
    })
    .catch(err => {
      console.error("Firebase error loading registrations:", err);
      showNotification("Error loading runners: " + (err && err.message ? err.message : err), 'error');
    });
}
// ---------- END loadRunners() ----------

    // ✅ Parse estimated time string into total seconds
    function parseEstimatedTime(timeStr) {
      if (!timeStr) return Infinity;
      // Expected formats: "20:15", "00:45:30"
      const parts = timeStr.split(":").map(Number);
      if (parts.length === 2) {
        return parts[0] * 60 + parts[1]; // MM:SS
      } else if (parts.length === 3) {
        return parts[0] * 3600 + parts[1] * 60 + parts[2]; // HH:MM:SS
      }
      return Infinity; // fallback
    }

    // ---------- Replace/Update your createBib() with this version (optional) ----------
function createBib(name, bibNum, estimatedMs) {
  const bibsDiv = document.getElementById("bibs");

  const bib = document.createElement("div");
  bib.className = "bib";

  // Logo (if uploaded)
  // Logo (if uploaded) -> bottom-left
if (uploadedLogo) {
  const logo = document.createElement("img");
  logo.className = "logo";
  logo.src = uploadedLogo;
  logo.alt = "Race Logo";
  bib.appendChild(logo);
}


  // Title
  const title = document.createElement("div");
  title.className = "race-title";
  title.textContent = "Brighton Oaks 5k";
  bib.appendChild(title);

  // Bib number
  const number = document.createElement("div");
  number.className = "bib-number";
  number.textContent = bibNum;
  bib.appendChild(number);

  // Runner name
  const runner = document.createElement("div");
  runner.className = "runner-name";
  runner.textContent = name;
  bib.appendChild(runner);

  // Optional: show estimated time (converted back to mm:ss.mmm)
  if (typeof estimatedMs === "number" && isFinite(estimatedMs)) {
    const estDiv = document.createElement("div");
    estDiv.style.fontSize = "16px";
    estDiv.style.marginTop = "6px";
    estDiv.textContent = "Est: " + msToTime(estimatedMs);
    bib.appendChild(estDiv);
  }

  // QR code
  const qrDiv = document.createElement("div");
  qrDiv.className = "qrcode";
  bib.appendChild(qrDiv);

  new QRCode(qrDiv, {
    text: "https://sites.google.com/view/brighton5k/results",
    width: 90,
    height: 90
  });

  bibsDiv.appendChild(bib);
}

function msToTime(ms) {
  const total = Math.floor(ms);
  const minutes = Math.floor(total / 60000);
  const seconds = Math.floor((total % 60000) / 1000);
  const msecs = total % 1000;
  return `${minutes}:${String(seconds).padStart(2, "0")}.${String(msecs).padStart(3, "0")}`;
}

// Notification system
function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  const showNotifications = document.getElementById('showNotifications').checked;
  
  if (!showNotifications) return;
  
  notification.textContent = message;
  notification.className = `notification ${type}`;
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

// Print function
function printBibs() {
  if (document.getElementById("bibs").children.length === 0) {
    showNotification("No bibs to print. Please load runners first.", 'warning');
    return;
  }
  
  showNotification("Preparing print...", 'warning');
  
  // Ensure print styles are applied
  const printArea = document.getElementById("bibs");
  if (printArea) {
    printArea.style.display = 'block';
  }
  
  // Try multiple print methods
  setTimeout(() => {
    try {
      // Method 1: Direct window.print()
      window.print();
      showNotification("Print dialog opened");
    } catch (error) {
      console.error("Print error:", error);
      
      // Method 2: Try with user gesture
      try {
        const printWindow = window.open('', '_blank');
        if (printWindow) {
          printWindow.document.write(`
            <html>
              <head>
                <title>Race Bibs</title>
                <style>
                  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                  .bib { 
                    width: 700px; height: 400px; border: 8px solid #000; 
                    border-radius: 20px; margin: 30px auto; background: white; 
                    position: relative; box-shadow: 0 6px 12px rgba(0,0,0,0.2); 
                    page-break-after: always; display: flex; flex-direction: column; 
                    justify-content: space-between; padding: 20px; 
                  }
                  .race-title { font-size: 40px; font-weight: bold; margin-top: 10px; text-transform: uppercase; letter-spacing: 2px; }
                  .bib-number { font-size: 160px; font-weight: bold; margin: 0 auto; text-align: center; }
                  .runner-name { font-size: 32px; font-weight: bold; margin-bottom: 20px; }
                  .qrcode { position: absolute; bottom: 20px; right: 20px; }
                  @media print { body { margin: 0; } .bib { box-shadow: none; margin: 0; } }
                </style>
              </head>
              <body>
                ${document.getElementById("bibs").innerHTML}
              </body>
            </html>
          `);
          printWindow.document.close();
          printWindow.print();
          printWindow.close();
          showNotification("Print dialog opened in new window");
        } else {
          showNotification("Print blocked. Please allow popups and try again.", 'error');
        }
      } catch (popupError) {
        console.error("Popup print error:", popupError);
        showNotification("Print failed. Please try Ctrl+P or Cmd+P", 'error');
      }
    }
  }, 200);
}

// Manual print function (fallback)
function manualPrint() {
  if (document.getElementById("bibs").children.length === 0) {
    showNotification("No bibs to print. Please load runners first.", 'warning');
    return;
  }
  
  showNotification("Use Ctrl+P (Windows) or Cmd+P (Mac) to print", 'warning');
  
  // Focus on the bibs area to help with printing
  document.getElementById("bibs").scrollIntoView({ behavior: 'smooth' });
}

// Keyboard shortcut for print
document.addEventListener('keydown', function(e) {
  // Ctrl+P or Cmd+P
  if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
    e.preventDefault();
    if (document.getElementById("bibs").children.length > 0) {
      printBibs();
    } else {
      showNotification("No bibs to print. Please load runners first.", 'warning');
    }
  }
});


  
// ---------- END createBib() ----------

  </script>
</body>
</html>

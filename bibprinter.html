<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" type="image/png" href="/Favicon Generator/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/Favicon Generator/favicon.svg" />
  <link rel="shortcut icon" href="/Favicon Generator/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/Favicon Generator/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="BO 5k" />
  <link rel="manifest" href="/Favicon Generator/site.webmanifest" />
  <!-- Include in <head> (once per page) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
   <style>
     :root {
       --accent: #3b6e22;
       --accent2: #ff7f11;
       --text-dark: #2c3e50;
       --text-light: #7f8c8d;
     }
     .navbar {
       display: flex;
       align-items: center;
       justify-content: space-between;
       padding: 16px 24px;
       background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
       box-shadow: 0 2px 20px rgba(0,0,0,0.08);
       position: sticky;
       top: 0;
       z-index: 1000;
       border-bottom: 1px solid rgba(60, 110, 34, 0.1);
     }
     .navbar .logo {
       display: flex;
       align-items: center;
       flex-shrink: 0;
     }
     .navbar .logo span {
       font-family: 'Luckiest Guy', cursive;
       font-size: 1.8rem;
       color: var(--accent2);
       letter-spacing: 1px;
       text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
     }
     .navbar .nav-links {
       display: flex;
       align-items: center;
       gap: 8px;
     }
     .navbar .nav-links a {
       color: var(--accent);
       text-decoration: none;
       font-weight: 600;
       font-size: 16px;
       padding: 8px 16px;
       border-radius: 8px;
       transition: all 0.3s ease;
       position: relative;
       overflow: hidden;
     }
     .navbar .nav-links a:hover {
       color: var(--accent2);
       background: rgba(255, 127, 17, 0.1);
       transform: translateY(-1px);
     }
     .navbar .nav-links a.active {
       background: var(--accent);
       color: white;
     }
     
     /* Mobile responsiveness */
     @media (max-width: 768px) {
       .navbar {
         padding: 12px 16px;
         flex-wrap: wrap;
       }
       .navbar .logo span {
         font-size: 1.4rem;
       }
       .navbar .nav-links {
         gap: 4px;
         margin-top: 8px;
         width: 100%;
         justify-content: center;
       }
       .navbar .nav-links a {
         font-size: 14px;
         padding: 6px 12px;
       }
     }
     
     @media (max-width: 480px) {
       .navbar .nav-links {
         flex-wrap: wrap;
         gap: 2px;
       }
       .navbar .nav-links a {
         font-size: 13px;
         padding: 4px 8px;
       }
     }
   </style>
  
  <!-- Place inside <body> at the very top -->
   <nav class="navbar">
     <div class="logo">
       <span>Brighton Oaks 5k</span>
     </div>
     <div class="nav-links">
       <a href="index.html">Home</a>
       <a href="registration.html" target="_blank">Register</a>
       <a href="orgnizer.html">Organizer</a>
       <a href="results.html">Results</a>
       <a href="bibprinter.html" class="active">Bib Printer</a>
     </div>
   </nav>
  <meta charset="UTF-8">
  <title>Race Bib Maker</title>
  <style>
    body {
      font-family: "Arial Black", sans-serif;
      text-align: center;
      padding: 20px;
      background: #f4f4f4;
    }
    button, input[type="file"] {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      font-weight: bold;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    input[type="file"] {
      background: #28a745;
    }
    input[type="file"]:hover {
      background: #1e7e34;
    }
    .bib {
      width: 700px;
      height: 400px;
      border: 8px solid #000;
      border-radius: 20px;
      margin: 30px auto;
      background: white;
      position: relative;
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
      page-break-after: always;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 20px;
    }
    .logo {
     position: absolute;
     bottom: 20px;
     left: 20px;
     width: 120px;
    }

    .race-title {
      font-size: 40px;
      font-weight: bold;
      margin-top: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .bib-number {
      font-size: 160px;
      font-weight: bold;
      margin: 0 auto;
      text-align: center;
    }
    .runner-name {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .qrcode {
      position: absolute;
      bottom: 20px;
      right: 20px;
    }
    #bibs {
      margin-top: 20px;
    }
    /* Notification system */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    }
    .notification.show {
      opacity: 1;
      transform: translateX(0);
    }
    .notification.error {
      background: #dc3545;
    }
    .notification.warning {
      background: #ffc107;
      color: #000;
    }
    
    /* Settings panel */
    .settings-panel {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border: 1px solid #dee2e6;
    }
    .settings-panel label {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 5px 0;
      font-size: 14px;
    }
    .settings-panel input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    @media print {
      body {
        background: white;
        margin: 0;
        padding: 0;
      }
      button, input[type="file"], h1, p, .settings-panel, .notification {
        display: none !important;
      }
      .bib {
        box-shadow: none;
        margin: 10px auto;
        page-break-inside: avoid;
      }
      #bibs {
        margin: 0;
        padding: 0;
      }
    }
  </style>
</head>
<body>
  <h1>Race Bib Maker</h1>
  
  <div class="settings-panel">
    <h3 style="margin-top:0;">Settings</h3>
    <label>
      <input type="checkbox" id="skipConfirmations" checked>
      Skip confirmation dialogs (faster operation)
    </label>
    <label>
      <input type="checkbox" id="showNotifications" checked>
      Show success notifications
    </label>
  </div>
  
  <p>Race logo: <strong>bright.png</strong> (automatically loaded)</p>
  <button onclick="loadRunners()">Load Runners & Generate Bibs</button>
  <button onclick="printBibs()">Print Bibs</button>
  <button onclick="manualPrint()" style="background:#17a2b8; color:white;">Manual Print (Ctrl+P)</button>
  
  <div id="bibs"></div>
  
  <!-- Notification container -->
  <div id="notification" class="notification"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <!-- QRCode library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
    // âœ… Replace with your Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyDUnAV-DL-Saw2ByPY6GF8aDaZbVCXDIH4",
    authDomain: "the-race-organizer.firebaseapp.com",
    databaseURL: "https://the-race-organizer-default-rtdb.firebaseio.com",
    projectId: "the-race-organizer",
    storageBucket: "the-race-organizer.firebasestorage.app",
    messagingSenderId: "265977321479",
    appId: "1:265977321479:web:23d3f3077e8e766323b2a2",
    measurementId: "G-PKGPD78DYM"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let uploadedLogo = "bright.png"; // Automatically set to bright.png

    // Load bright.png automatically when page loads
    window.addEventListener('load', function() {
      // Set the logo to bright.png automatically
      uploadedLogo = "bright.png";
      showNotification("Bright.png logo loaded automatically");
    });

    // ---------- REPLACE loadRunners() WITH THIS ----------
function loadRunners() {
  const bibsDiv = document.getElementById("bibs");
  bibsDiv.innerHTML = "";

  database.ref("registrations").once("value")
    .then(snapshot => {
      const data = snapshot.val();
      if (!data) {
        showNotification("No runners found in Firebase.", 'warning');
        return;
      }

      // Build array of runners from the random-code children
      const runners = Object.keys(data).map(key => {
        const entry = data[key] || {};
        // robust name lookup with fallbacks
        const name = entry.name || entry.runnerName || entry.displayName || key;

        // robust estimated-time lookup & numeric conversion
        let raw = entry.estimatedtime ?? entry.estimatedTime ?? entry.estimated ?? null;
        let estimated;
        if (raw === null || raw === undefined || raw === "") {
          estimated = Infinity; // push missing times to the end
        } else {
          estimated = Number(raw);
          if (isNaN(estimated)) {
            // try to salvage digits if stored oddly
            const digits = String(raw).replace(/\D/g, "");
            const p = digits ? parseInt(digits, 10) : NaN;
            estimated = isNaN(p) ? Infinity : p;
          }
        }
        return { key, name, estimated, raw };
      });

      console.log("Loaded runners (before sort):", runners.map(r => ({ name: r.name, estimated: r.estimated })));

      // Sort by numeric milliseconds (ascending = fastest first).
      // Tie-breaker: name alphabetical (deterministic)
      runners.sort((a, b) => {
        if (a.estimated !== b.estimated) return a.estimated - b.estimated;
        return ("" + a.name).localeCompare(b.name);
      });

      console.log("Runners (after sort):", runners.map((r, i) => ({ rank: i + 1, name: r.name, estimated: r.estimated })));

      // Create bibs in sorted order
      runners.forEach((runner, index) => {
        const bibNum = String(index + 1).padStart(4, "0"); // 0001, 0002, ...
        createBib(runner.name, bibNum, runner.estimated);
      });
      
      showNotification(`Loaded ${runners.length} runners and generated bibs`);
    })
    .catch(err => {
      console.error("Firebase error loading registrations:", err);
      showNotification("Error loading runners: " + (err && err.message ? err.message : err), 'error');
    });
}
// ---------- END loadRunners() ----------

    // âœ… Parse estimated time string into total seconds
    function parseEstimatedTime(timeStr) {
      if (!timeStr) return Infinity;
      // Expected formats: "20:15", "00:45:30"
      const parts = timeStr.split(":").map(Number);
      if (parts.length === 2) {
        return parts[0] * 60 + parts[1]; // MM:SS
      } else if (parts.length === 3) {
        return parts[0] * 3600 + parts[1] * 60 + parts[2]; // HH:MM:SS
      }
      return Infinity; // fallback
    }

    // ---------- Replace/Update your createBib() with this version (optional) ----------
function createBib(name, bibNum, estimatedMs) {
  const bibsDiv = document.getElementById("bibs");

  const bib = document.createElement("div");
  bib.className = "bib";

  // Logo (if uploaded)
  // Logo (bright.png) -> bottom-left
if (uploadedLogo) {
  const logo = document.createElement("img");
  logo.className = "logo";
  logo.src = uploadedLogo;
  logo.alt = "Brighton Oaks 5k Logo";
  bib.appendChild(logo);
}


  // Title
  const title = document.createElement("div");
  title.className = "race-title";
  title.textContent = "Brighton Oaks 5k";
  bib.appendChild(title);

  // Bib number
  const number = document.createElement("div");
  number.className = "bib-number";
  number.textContent = bibNum;
  bib.appendChild(number);

  // Runner name
  const runner = document.createElement("div");
  runner.className = "runner-name";
  runner.textContent = name;
  bib.appendChild(runner);

  // Optional: show estimated time (converted back to mm:ss.mmm)
  if (typeof estimatedMs === "number" && isFinite(estimatedMs)) {
    const estDiv = document.createElement("div");
    estDiv.style.fontSize = "16px";
    estDiv.style.marginTop = "6px";
    estDiv.textContent = "Est: " + msToTime(estimatedMs);
    bib.appendChild(estDiv);
  }

  // QR code
  const qrDiv = document.createElement("div");
  qrDiv.className = "qrcode";
  bib.appendChild(qrDiv);

  new QRCode(qrDiv, {
    text: "https://sites.google.com/view/brighton5k/results",
    width: 90,
    height: 90
  });

  bibsDiv.appendChild(bib);
}

function msToTime(ms) {
  const total = Math.floor(ms);
  const minutes = Math.floor(total / 60000);
  const seconds = Math.floor((total % 60000) / 1000);
  const msecs = total % 1000;
  return `${minutes}:${String(seconds).padStart(2, "0")}.${String(msecs).padStart(3, "0")}`;
}

// Notification system
function showNotification(message, type = 'success') {
  const notification = document.getElementById('notification');
  const showNotifications = document.getElementById('showNotifications').checked;
  
  if (!showNotifications) return;
  
  notification.textContent = message;
  notification.className = `notification ${type}`;
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

// Print function
function printBibs() {
  if (document.getElementById("bibs").children.length === 0) {
    showNotification("No bibs to print. Please load runners first.", 'warning');
    return;
  }
  
  showNotification("Preparing print...", 'warning');
  
  // Ensure print styles are applied
  const printArea = document.getElementById("bibs");
  if (printArea) {
    printArea.style.display = 'block';
  }
  
  // Try multiple print methods
  setTimeout(() => {
    try {
      // Method 1: Direct window.print()
      window.print();
      showNotification("Print dialog opened");
    } catch (error) {
      console.error("Print error:", error);
      
      // Method 2: Try with user gesture
      try {
        const printWindow = window.open('', '_blank');
        if (printWindow) {
          printWindow.document.write(`
            <html>
              <head>
                <title>Race Bibs</title>
                <style>
                  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                  .bib { 
                    width: 700px; height: 400px; border: 8px solid #000; 
                    border-radius: 20px; margin: 30px auto; background: white; 
                    position: relative; box-shadow: 0 6px 12px rgba(0,0,0,0.2); 
                    page-break-after: always; display: flex; flex-direction: column; 
                    justify-content: space-between; padding: 20px; 
                  }
                  .race-title { font-size: 40px; font-weight: bold; margin-top: 10px; text-transform: uppercase; letter-spacing: 2px; }
                  .bib-number { font-size: 160px; font-weight: bold; margin: 0 auto; text-align: center; }
                  .runner-name { font-size: 32px; font-weight: bold; margin-bottom: 20px; }
                  .qrcode { position: absolute; bottom: 20px; right: 20px; }
                  @media print { body { margin: 0; } .bib { box-shadow: none; margin: 0; } }
                </style>
              </head>
              <body>
                ${document.getElementById("bibs").innerHTML}
              </body>
            </html>
          `);
          printWindow.document.close();
          printWindow.print();
          printWindow.close();
          showNotification("Print dialog opened in new window");
        } else {
          showNotification("Print blocked. Please allow popups and try again.", 'error');
        }
      } catch (popupError) {
        console.error("Popup print error:", popupError);
        showNotification("Print failed. Please try Ctrl+P or Cmd+P", 'error');
      }
    }
  }, 200);
}

// Manual print function (fallback)
function manualPrint() {
  if (document.getElementById("bibs").children.length === 0) {
    showNotification("No bibs to print. Please load runners first.", 'warning');
    return;
  }
  
  showNotification("Use Ctrl+P (Windows) or Cmd+P (Mac) to print", 'warning');
  
  // Focus on the bibs area to help with printing
  document.getElementById("bibs").scrollIntoView({ behavior: 'smooth' });
}

// Keyboard shortcut for print
document.addEventListener('keydown', function(e) {
  // Ctrl+P or Cmd+P
  if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
    e.preventDefault();
    if (document.getElementById("bibs").children.length > 0) {
      printBibs();
    } else {
      showNotification("No bibs to print. Please load runners first.", 'warning');
    }
  }
});

  </script>
     <style>
   .footer {
     background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
     color: #fff;
     text-align: center;
     padding: 40px 20px 20px 20px;
     position: relative;
     margin-top: 40px;
     border-top: 3px solid var(--accent2);
   }
   .footer::before {
     content: '';
     position: absolute;
     top: 0;
     left: 0;
     right: 0;
     height: 3px;
     background: linear-gradient(90deg, var(--accent) 0%, var(--accent2) 50%, var(--accent) 100%);
   }
   .footer .footer-art {
     width: 180px;
     max-width: 80vw;
     margin: 0 auto 20px auto;
     display: block;
     filter: drop-shadow(0 4px 12px rgba(0,0,0,0.3));
     transition: transform 0.3s ease;
   }
   .footer .footer-art:hover {
     transform: scale(1.05);
   }
   .footer p {
     margin: 0;
     font-size: 1rem;
     color: #ecf0f1;
     opacity: 0.9;
     font-weight: 500;
   }
   .footer .footer-links {
     margin-top: 16px;
     display: flex;
     justify-content: center;
     gap: 24px;
     flex-wrap: wrap;
   }
   .footer .footer-links a {
     color: #bdc3c7;
     text-decoration: none;
     font-size: 14px;
     transition: color 0.3s ease;
   }
   .footer .footer-links a:hover {
     color: var(--accent2);
   }
   @media (max-width: 768px) {
     .footer {
       padding: 30px 16px 16px 16px;
     }
     .footer .footer-art { 
       width: 140px; 
     }
     .footer .footer-links {
       gap: 16px;
     }
   }
   @media (max-width: 480px) {
     .footer .footer-art { 
       width: 120px; 
     }
     .footer .footer-links {
       flex-direction: column;
       gap: 8px;
     }
   }
    </style>

   <!-- Place inside <body> at the very bottom -->
   <footer class="footer">
     <img src="Favicon Generator/web-app-manifest-192x192.png" alt="Runner Art" class="footer-art" />
     <p>Â© 2025 Brighton Oaks 5k. All rights reserved.</p>
     <div class="footer-links">
       <a href="index.html">Home</a>
       <a href="registration.html">Register</a>
       <a href="orgnizer.html">Organizer</a>
       <a href="results.html">Results</a>
       <a href="bibprinter.html">Bib Printer</a>
     </div>
   </footer>
  


  </script>
</body>
</html>
